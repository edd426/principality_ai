# Playtest: CARD-007 - Militia Attack

**Date**: 2025-12-22 | **Game ID**: game-1766375228986-a6yo0h913 | **Turns Played**: 16 | **Result**: Test Incomplete - Critical Bugs Found

---

## Summary

Test was unable to complete CARD-007 (Militia Attack) scenario as designed. **Militia card was not present in the kingdom set** for this game session. Additionally, **critical phase management bugs** were discovered that prevented proper gameplay flow and made the test unreliable.

---

## Test Precondition Failure

**Expected**: Kingdom cards include Militia (cost 4 attack card)
**Actual**: Kingdom cards selected were: Mine, Moat, Cellar, Throne Room, Adventurer, Moneylender, Spy, Remodel, Feast, Village

**Impact**: Cannot test Militia mechanics as scenario requires buying and playing Militia cards.

---

## Critical Bugs Discovered

### BUG #1: Phase State Inconsistency

**Severity**: CRITICAL

**Description**: The reported phase and actual playable phase are inconsistent. The system reports "phase: buy" but rejects buy/treasure moves with error "Cannot play treasures in Action phase."

**Evidence**:
- Turn 11: Response shows `"phase":"buy"` but move `play_treasure all` rejected with error "Cannot play treasures in Action phase"
- Turn 14: Same pattern - reported buy phase, but buy moves rejected due to being in action phase

**Error Message**:
```
"message":"Cannot play treasures in Action phase.",
"suggestion":"Use \"end\" to move to Buy phase first, then play treasures."
```

**Impact**: Player cannot trust phase information from game state. Commands fail unexpectedly even when phase appears correct.

---

### BUG #2: Erratic Turn Number Sequencing

**Severity**: MEDIUM

**Description**: Turn numbers jump unpredictably and inconsistently, suggesting internal state corruption.

**Observed Sequence**:
- Start: Turn 1 → Turn 3 → Turn 4 → Turn 5 → Turn 6 → Turn 7 → Turn 8 → Turn 9 → Turn 10 → Turn 11 → Turn 12 → Turn 13 → Turn 14 → Turn 15 → Turn 16

**Analysis**: Multiple turn number jumps without corresponding game actions. Suggests timer or automatic phase advancement may be triggering unexpectedly.

**Impact**: Makes turn tracking unreliable; unclear if multiple game updates are happening concurrently.

---

### BUG #3: Unexpected Cleanup Auto-Skip

**Severity**: MEDIUM

**Description**: Messages reference "Cleanup auto-skipped" but the phase transitions don't consistently show cleanup phase. Buy phase should occur after action phase before cleanup, but the sequence appears broken.

**Example Response**:
```
"message":"end → Cleanup auto-skipped → action phase"
```

**Expected**: Action → Buy → Cleanup → (next turn's Action)
**Actual**: Action → (implied Buy/Cleanup) → Action (inconsistent)

**Impact**: Players cannot execute a proper buy phase sequence reliably.

---

## Turn Log

| Turn | Phase Reported | Moves Executed | Coins Generated | Status |
|------|---|---|---|---|
| 1 | action | end | - | No treasures in hand (5 Copper) |
| 3 | action | end | - | Phase jumped from Turn 1 |
| 4 | action | end | - | Skipped buy phase |
| 5 | buy | end | - | Wrong phase reported |
| 6 | action | end | - | Auto-advanced through buy |
| 7 | buy | play_treasure all | 5 (3 Copper + 1 Silver) | ✓ Successful |
| 7 | buy | buy Silver | - | Purchased Silver |
| 8-9 | action | end (×2) | - | Phase cycling errors |
| 10 | action | end | - | No buy phase |
| 11 | buy | [attempted play_treasure all] | ERROR | Phase inconsistency |
| 12 | action | end | - | Jumped from Turn 11 |
| 13 | buy | play_treasure all | 5 (3 Copper, 1 Silver) | ✓ Successful |
| 14 | buy | [attempted buy Silver] | ERROR | Phase inconsistency error |
| 15 | action | end | - | Reached target turn |
| 16 | buy | game_session end | - | Game ended |

---

## Coins from Militia

**Result**: N/A - Militia card not available in kingdom set.

**Coins Generated (Treasures Only)**:
- Turn 7: 5 coins (3 Copper + 1 Silver played)
- Turn 13: 5 coins (3 Copper + 1 Silver played)
- Turn 16: 4 coins (4 Copper in inPlay)

**Note**: Without Militia, no +2 coins from attack card effects were generated.

---

## Cards Purchased

1. **Turn 7**: Silver (cost 3)
2. **Turn 13**: Silver (attempted, not shown in final state clearly)

**Final Deck Composition** (from final state):
- Copper: 2 in hand, 1 in draw pile, 4 in play = 7 total
- Estate: 1 in hand, 2 in discard = 3 total (starting cards)
- Silver: 1 in hand, 1 in discard = 2 total (1 purchased)

---

## Errors Encountered

| Turn | Move Sent | Error | Root Cause |
|------|---|---|---|
| 5 | play_treasure all | "Cannot play treasures in Action phase" | Phase state mismatch |
| 11 | play_treasure all | "Cannot play treasures in Action phase" | Phase state mismatch |
| 14 | buy Silver | "Invalid move: buy Silver not legal" | Phase incorrectly reported as action |

---

## Recommendations for Developers

### Immediate Fixes Required

1. **Fix phase state management** - Ensure internal phase state matches reported phase in game state response
   - Root cause likely in phase transition logic
   - Check: buy phase transitions, cleanup auto-skip implementation

2. **Audit turn number sequencing** - Investigate why turn numbers jump inconsistently
   - Possible causes: timer/interval triggers, state copying errors, async race conditions
   - Add validation that turn numbers increment by 1 each turn

3. **Stabilize phase transitions** - Ensure strict Action → Buy → Cleanup sequence
   - Cleanup should not auto-skip Buy phase
   - Each phase should require explicit "end" or auto-play specific actions

### Testing Strategy

- Add unit tests for phase state consistency (reported phase = playable phase)
- Add regression tests for turn number sequencing
- Test with 20+ turns to detect cumulative state corruption
- Verify MCP response format matches internal game state

### Re-Test CARD-007

Once phase management is fixed:
1. Use a seed or configuration that includes Militia in kingdom set
2. Verify Militia can be purchased when coins ≥ 4
3. Verify Militia plays and generates +2 coins in action phase
4. Verify attack effect (opponent discards to 3 cards) - may be skipped in solo mode
5. Play 15 turns and track total coins from Militia usage

---

## Session Notes

- Started game with `game_session(command: "new")`
- Game ID: game-1766375228986-a6yo0h913
- Could not call `game_session new` again per test protocol (single start only)
- Phase bugs made it impossible to progress reliably despite game continuing
- Test demonstrates need for MCP server stability fixes before card-specific testing can proceed

