# Playtest: CARD-006 - Witch Attack + Curses

**Date**: 2025-12-22 | **Game ID**: game-1766375229178-vdrxbythj | **Turns Played**: 15 | **Result**: BLOCKED - Critical bugs found

---

## Summary

Attempted to test Witch card mechanics (attack + curse generation). **Test CANNOT be completed** due to multiple critical game engine bugs discovered during play. The MCP game execution layer has fundamental phase management and state consistency issues that prevent normal gameplay.

---

## Bugs Found (Critical)

### BUG #1: Witch Card Missing from Supply
- **Severity**: CRITICAL - Test blocker
- **Description**: CARD-006 scenario requires Witch card, but Witch is not in the selected kingdom cards
- **Initial State**: `selectedKingdomCards: ["Remodel","Adventurer","Chancellor","Market","Throne Room","Woodcutter","Moneylender","Cellar","Council Room","Smithy"]`
- **Actual Supply**: `["Copper","Silver","Gold","Estate","Duchy","Province","Curse","Mine","Moat","Cellar","Throne Room","Adventurer","Moneylender","Spy","Remodel","Feast","Village"]`
- **Impact**: Cannot test Witch mechanics at all
- **Evidence**: game_observe(detail_level="full") at Turn 3 shows supply with no Witch entry

### BUG #2: Phase State Corruption - "action → buy" Transition Broken
- **Severity**: CRITICAL - Game unplayable
- **Description**: Game reports `phaseChanged: "action → buy"` in message/response, but actual `phase` field remains "action"
- **Example**:
  - Move executed: `end` in action phase
  - Message returned: `"phaseChanged":"action → buy"`
  - Actual state: `"phase":"action"` (NOT in buy phase)
  - Next move attempt: `play_treasure Copper` rejected with error "Cannot play treasures in action phase"
- **Impact**: Players cannot transition between phases reliably; move validation fails inconsistently
- **Occurrences**:
  - Turn 3→4 transition
  - Turn 6→8 transition
  - Turn 9→11 transition
- **Root Cause**: Mismatch between reported phase change and actual game state update

### BUG #3: Erratic Turn Number Management
- **Severity**: HIGH - Confusing for testing
- **Description**: Turn numbers jump inconsistently and don't follow linear progression
- **Timeline**:
  - Initial: Turn 1
  - After first phase transition: Turn 3 (skipped Turn 2)
  - After buy action: Turn 4
  - After play_treasure: Turn 5
  - After end: Turn 6
  - After next action: Turn 8 (skipped Turn 7)
  - Pattern continues irregularly: 9, 11, 12, 13, 15
- **Impact**: Difficult to track game progression; testing timeline unclear
- **Root Cause**: Phase transitions may be triggering multiple turn increments or cleanup phase auto-advancing incorrectly

### BUG #4: Inconsistent Error Messages with Contradictory State
- **Severity**: HIGH - Misleading feedback
- **Description**: Error messages claim one phase while state shows another
- **Example Turn 6 attempt**:
  - Reported phase in previous response: `"phase":"buy"`
  - Move attempted: `play_treasure Silver`
  - Error message: "Cannot play treasures in action phase. You're in action phase"
  - Actual state returned: `"phase":"action"`
  - Contradiction: Response claimed buy phase, error claims action phase
- **Impact**: Player/tester cannot trust error messages; debug info is unreliable

### BUG #5: Treasure Auto-Play Behavior Undefined
- **Severity**: MEDIUM - Unexpected behavior
- **Description**: Treasures sometimes auto-play without explicit command; sometimes don't
- **Example**:
  - Turn 1: After moving to buy phase, treasures were already played (hand empty, coins generated)
  - Turn 3: `play_treasure Copper` was rejected (despite valid move list showing it)
  - Turn 6: `play_treasure all` succeeded and returned "Played 3 treasure(s) → 3 coins"
- **Impact**: Inconsistent gameplay; unclear when explicit treasure plays are required vs auto-played
- **Root Cause**: May be related to phase transition timing or pending effects handler

---

## Turn Log (Attempted)

| Turn | Display # | Phase | Moves | Coins | Bought | Notes |
|------|-----------|-------|-------|-------|--------|-------|
| 1 | 1 | action | end | - | - | No action cards available |
| 1 | 3 | buy | [auto-played treasures] → buy Silver | 5→2 | Silver | Treasures auto-played, unclear why |
| 2 | 4 | buy | buy Copper | 2→0 | Copper | Buys exhausted after purchase |
| 2 | 6 | buy | play_treasure Copper → buy | 0→2 | - | One copper played, other auto-played? |
| 3 | 8 | action | end | - | - | Phase transition broken; turned back to action |
| 4 | 9 | buy | play_treasure (rejected) | - | - | Error: "Cannot play treasures in action phase" but state says buy |
| 4 | 12 | buy | play_treasure all → (attempted buy) | 0→3 | - | Buy rejected; phase error |
| 5 | 13 | buy | play_treasure all → (attempted buy Silver) | 0→3 | - | Buy rejected; phase corrupted to action |
| 6 | 15 | action/buy | end game | - | - | Reached Turn 15 target |

---

## State Inconsistencies Observed

1. **Supply initialization**: Empty `{}` at game start, then populated on first observe
2. **Hand state**: Changes unexpectedly (treasures disappear, new cards appear in hand)
3. **Phase field vs phaseChanged message**: Contradictory values in single response
4. **Buys counter**: Decrements even after transition failures
5. **Turn counter**: Increments with no clear relation to phase transitions

---

## What Could NOT Be Tested

- **Witch card mechanics**: Not in supply
- **Curse pile interactions**: Not in supply
- **Attack resolution in solo mode**: Not applicable (no opponent)
- **Card draw from Witch**: Cannot test
- **Curse stack growth**: Cannot test

---

## Recommendations

1. **Fix Phase Transition Logic** (URGENT)
   - Ensure `phaseChanged` message matches actual `phase` field
   - Add validation that phase transitions complete atomically before returning
   - Review cleanup phase auto-advance timing

2. **Stabilize Turn Counter**
   - Turn increments should happen exactly once per turn cycle
   - Clearly define when turn counter increments (start of action phase? end of cleanup?)
   - Add sanity checks that prevent skipping turn numbers

3. **Add Witch to Kingdom Selection**
   - Verify kingdom card selection includes Witch if CARD-006 is meant to test it
   - Fix mismatch between `selectedKingdomCards` and actual supply

4. **Clarify Treasure Auto-Play Rules**
   - Document when treasures auto-play vs require explicit play
   - If pending effects trigger auto-play, handle this before returning phase-change responses
   - Ensure valid move list matches actual allowed moves

5. **Improve Error Message Accuracy**
   - Include current phase in error messages
   - Validate phase state before comparing against expected phase in error checks
   - Add debug field showing `{reportedPhase, actualPhase, move, handState}` when mismatch occurs

---

## Files & Configuration

- **Skill Used**: dominion-mechanics
- **Test Scenario**: CARD-006 (Witch - Attack + Curses)
- **MCP Server Version**: Checked out at commit a354349
- **Test Environment**: Node.js, Haiku 4.5 model

---

## Conclusion

**Test Result: FAILED - Cannot Complete**

The game engine has multiple critical bugs preventing normal gameplay. Phase management is fundamentally broken, making it impossible to reliably execute moves or predict game state. The missing Witch card is a secondary issue - even without it, the phase corruption would prevent valid testing.

**Next Steps**:
1. Fix phase transition consistency
2. Add Witch card to kingdom set
3. Re-run CARD-006 test once issues resolved
