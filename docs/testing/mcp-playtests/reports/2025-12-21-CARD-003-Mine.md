# Playtest: CARD-003 - Mine Treasure Upgrading

**Date**: 2025-12-21 | **Game ID**: game-1766324334123-l5glcg9jp | **Turns Completed**: 5 | **Result**: BLOCKED BY BUG

## Summary

Tested Mine card's trash-and-gain mechanic. Successfully played Mine in turn 5, triggering the pending effect (select which treasure to trash). **CRITICAL BUG**: Pending effect command syntax is broken - the system lists valid moves but rejects all command formats. Game is stuck and unplayable after Mine is played.

---

## Turn Log

| Turn | Phase Actions | Coins | Purchased | Notes |
|------|---------------|-------|-----------|-------|
| 1 | end → play_treasure all → buy Silver → end | 4→2 | Silver | Starting hand: 4 Copper, 1 Estate |
| 2 | end → play_treasure all → buy Silver → end | 6→1 | Silver | Hand now: 4 Copper, 1 Silver |
| 3 | end → play_treasure all → buy Mine → end | 7→2 | Mine | Success: Bought Mine (cost 5) |
| 4 | Auto-advanced to buy | 4 | Silver | Mine in discard, will draw soon |
| 5 | play_action Mine | N/A | N/A | **MINE PLAYED - STUCK AT PENDING EFFECT** |

---

## Detailed Analysis

### Turn 1-3: Successful Buildup
- Followed strategy: buy Silver until 5+ coins, then buy Mine
- Turn 3: Successfully purchased Mine with 7 coins (leaves 2 coins)
- Cleanup and draw cycle working correctly

### Turn 4-5: Mine Card Draw and Play
- Turn 4: Mine in discard pile (not yet in hand)
- Turn 5: Mine drawn into hand, action phase triggered
- **game_observe** shows validMoves: `["play_action Mine"]`
- Successfully executed `play_action Mine` (cards in hand changed: Silver, Estate, Copper remain)
- Mine removed from hand, currentActions dropped to 0

### Turn 5: Pending Effect Triggered
After playing Mine, the game state changed:
- **validMoves**:
  ```
  [
    {"type":"select_treasure_to_trash","card":"Silver"},
    {"type":"select_treasure_to_trash","card":"Copper"}
  ]
  ```
- Current hand: Silver (1), Estate (1), Copper (2)
- **Expected behavior**: Select one treasure to trash, gain one treasure cost+1
- **Actual behavior**: No valid command syntax works

---

## Bugs Found

### BUG #1: CRITICAL - Pending Effect Command Syntax Broken

**Severity**: CRITICAL (blocks all Mine gameplay)

**Issue**: After Mine card is played, pending effect shows valid moves but parser cannot execute them.

**Expected**: One of these commands should work:
- `select_treasure_to_trash Silver`
- `select_treasure_to_trash Copper`
- `select 0` (Silver)
- `select 2` (Copper)

**Tested Syntax Variations** (all rejected):
1. `select_treasure_to_trash` → "Cannot parse move"
2. `select_treasure_to_trash Silver` → "Cannot parse move"
3. `select_treasure_to_trash:Silver` → "Cannot parse move"
4. `Silver` → "Cannot parse move"
5. `Copper` → "Cannot parse move"
6. `0` → "Cannot parse move"
7. `play 0` → "Cannot play treasures in action phase"
8. `play_treasure 0` → "Cannot play treasure '0': not in hand"
9. `play Silver` → "Invalid index: silver"

**Game State When Bug Occurs**:
```json
{
  "phase": "action",
  "turnNumber": 12,
  "hand": {"Silver": 1, "Estate": 1, "Copper": 2},
  "currentActions": 0,
  "currentBuys": 1,
  "validMoves": [
    {"type": "select_treasure_to_trash", "card": "Silver"},
    {"type": "select_treasure_to_trash", "card": "Copper"}
  ]
}
```

**Root Cause**: The move parser (`generateMoveOptions` or equivalent) does not have a handler for `select_treasure_to_trash` command type. The move is listed in validMoves but cannot be executed.

**Impact**:
- Mine card is completely unplayable
- Any pending effect that requires selecting a card will be stuck
- Blocks CARD-003 testing entirely

**Fix Required**:
- Add command parser for pending effects
- Likely formats to support:
  - `select_treasure_to_trash Silver` (card name)
  - `select_treasure_to_trash 0` (card index)
  - Or use an existing command syntax and map it to pending effect context

---

### BUG #2: Phase State Reporting Inconsistency

**Severity**: MEDIUM (confusing but not blocking after workaround)

**Issue**: Response objects sometimes report wrong phase that contradicts game_observe.

**Example**:
- `game_observe` says phase = "buy"
- `game_execute` error says "Cannot play treasures in Action phase"
- Next `game_execute` response shows phase = "action"

**Occurrence**: Turns 2-4, multiple times

**Impact**: Confusing error messages but game recovers on retry

**Possible Cause**: Race condition or state update delay between moves

---

### BUG #3: TurnNumber Increments Unexpectedly

**Severity**: LOW (informational)

**Issue**: turnNumber increments by 2 after phase transitions instead of 1

**Example Sequence**:
```
Turn 1, phase=action → end → Turn 2, phase=buy (expected)
Turn 2, phase=buy → end → Turn 3, phase=action (but turnNumber=3, should be 2)
```

**Hypothesis**: Cleanup phase auto-advance might be incrementing turnNumber twice

**Impact**: Tracking turns is confusing but doesn't affect gameplay logic

---

## Feature Implementation Assessment

### Mine Card Logic (Partial - BLOCKED)

**What Works**:
- ✅ Mine card is in supply at cost 5
- ✅ Mine can be purchased with correct coin amount
- ✅ Mine is added to deck and drawn correctly
- ✅ Mine card is playable in action phase
- ✅ Playing Mine correctly:
  - Removes card from hand
  - Consumes action
  - Generates pending effect
- ✅ Pending effect correctly identifies valid treasures to trash
- ✅ Gain treasure mechanics (based on validMoves) appear properly configured

**What's Broken**:
- ❌ No command syntax to execute pending effect selection
- ❌ Game cannot proceed after pending effect is triggered

**Expected Behavior** (from Dominion rules):
1. Player plays Mine
2. System prompts: "Choose a treasure in your hand to trash"
3. Player selects one treasure (e.g., Copper)
4. Copper is trashed (removed from game)
5. Gold (cost 3 + Copper cost 0 = 3, gain Silver which costs 2) is added to player's hand
6. Mine resolves, action phase continues (or ends if no more actions)

**Current Behavior**:
1. ✅ Player plays Mine
2. ✅ System generates pending effect with two options
3. ❌ Player cannot execute any command to proceed
4. ❌ Game stuck, cannot continue

---

## Command Syntax Analysis

**Current Parser Patterns** (from error messages):
- `play 0` - index-based card play (auto-detects action vs treasure)
- `play_action CardName` - explicit action card play
- `play_treasure CardName` - explicit treasure play
- `buy CardName` - purchase card
- `end` - phase transition

**Missing Pattern**:
- Pending effect selection command
- No syntax like `select XYZ` is accepted
- The move type `select_treasure_to_trash` has no parser implementation

---

## Test Conclusion

**Status**: BLOCKED

Cannot continue CARD-003 testing beyond turn 5 due to critical pending effect bug. The Mine card's core mechanic (trash-and-gain treasure) cannot be executed.

**Recommendations for Fixing**:
1. **Priority 1**: Implement command syntax for pending effects
   - Add parser handler for `select_treasure_to_trash`
   - Support syntax: `select_treasure_to_trash CardName` or index-based equivalent
2. **Priority 2**: Fix phase state reporting inconsistency
   - Ensure `game_execute` response accurately reflects current phase
3. **Priority 3**: Fix turnNumber increment logic
   - Verify cleanup phase doesn't double-increment

**Next Steps**:
1. Implement pending effect command parsing
2. Re-run CARD-003 for full 15-turn coverage
3. Test Mine trash-to-gain mechanics across all treasure combinations:
   - Copper → Silver
   - Silver → Gold
   - Copper → Gold (if implemented as higher-cost gain)

---

## Test Environment

- Game ID: game-1766324334123-l5glcg9jp
- Kingdom Cards: Mine, Throne Room, Remodel, Spy, Library, Thief, Workshop, Moat, Chapel, Laboratory
- Player Deck State (Turn 5):
  - Hand: Silver, Estate, Copper, Copper, Estate
  - Deck: Copper, Copper
  - Discard: Copper, Silver, Silver, Mine, Estate (5 cards including newly purchased Mine)
  - VP: 3 (from 3 Estates)

---

## Appendix: Move Attempt Log

All attempted command syntaxes for pending effect (Turn 5):

```
ATTEMPT 1: select_treasure_to_trash
ERROR: Cannot parse move: "select_treasure_to_trash". Invalid format.

ATTEMPT 2: select_treasure_to_trash Copper
ERROR: Cannot parse move: "select_treasure_to_trash Copper". Invalid format.

ATTEMPT 3: select_treasure_to_trash:Silver
ERROR: Cannot parse move: "select_treasure_to_trash:Silver". Invalid format.

ATTEMPT 4: Copper
ERROR: Cannot parse move: "Copper". Invalid format.

ATTEMPT 5: 0
ERROR: Cannot parse move: "0". Invalid format.

ATTEMPT 6: play 2
ERROR: Invalid move: "play 2" is not legal in current game state. Cannot play treasures in action phase.

ATTEMPT 7: play Silver
ERROR: Invalid index: silver. Must be 0-3

ATTEMPT 8: play_treasure 0
ERROR: Cannot play treasure "0": not in hand

ATTEMPT 9: play 0
ERROR: Invalid move: "play 0" is not legal in current game state. Cannot play treasures in action phase.
```

All attempts failed. No syntax variant accepted.
