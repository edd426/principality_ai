# UX-002 Phase Transition Clarity Test Report

**Date**: 2025-12-21
**Test ID**: UX-002
**Tester**: Claude Agent (Game Tester)
**Duration**: 15 turns
**Status**: CRITICAL ISSUES FOUND

---

## Executive Summary

Phase transitions in the MCP game server exhibit **severe clarity and consistency problems**. The `gameState.phase` field frequently contradicts the game engine's internal phase state, `phaseChanged` messages report incorrect previous phases, and the turn numbering increments unpredictably. These issues make it extremely difficult for players and testing systems to understand the current game state and anticipate valid moves.

---

## Test Methodology

1. Started one new game via `game_session new`
2. Executed moves sequentially, capturing full JSON responses
3. After each move, recorded:
   - `gameState.phase` from response
   - `phaseChanged` message (if present)
   - `turnNumber` changes
   - Error messages and their stated phase
   - `validMoves` array
4. Identified inconsistencies and contradictions
5. Continued until turn 15 (stopped before turn 30 limit)

---

## Critical Issues Found

### Issue 1: Phase State Contradictions

**Severity**: CRITICAL

The `gameState.phase` field frequently contradicts what the game engine believes the phase to be. Evidence:

**Turn 6-7 Transition**:
```json
RESPONSE (Turn 6):
{
  "gameState": {
    "phase": "buy",
    "turnNumber": 6
  },
  "validMoves": ["play_treasure Copper", "play_treasure Silver", ...]
}

NEXT MOVE: play_treasure Copper (succeeds)

RESPONSE (Turn 7):
{
  "gameState": {
    "phase": "action",
    "turnNumber": 7
  },
  "validMoves": ["end"]
},
"error": {
  "message": "Invalid move: \"play_treasure Copper\" is not legal in current game state.",
  "suggestion": "Cannot play treasures in action phase. You're in action phase..."
}
```

**Analysis**:
- Turn 6 showed `phase: "buy"` with treasure plays available
- Single treasure play succeeded on turn 6
- Turn 7 suddenly in `phase: "action"` with error saying treasures cannot be played
- This suggests the internal phase state and reported phase are out of sync

### Issue 2: Ambiguous phaseChanged Messages

**Severity**: CRITICAL

The `phaseChanged` field reports transitions that don't match the actual phase progression:

**Turn 1 → 2**:
```
Message: "end → Cleanup auto-skipped → action phase"
phaseChanged: "buy → cleanup"
gameState.phase: "action"
turnNumber: 2
```
- Says cleanup was "auto-skipped" but also says "buy → cleanup"
- Contradictory: if buy went to cleanup, what was skipped?
- Phase is "action" but message suggests cleanup happened

**Turn 3 → 5**:
```
Move 1 (Turn 3): phaseChanged: "buy → cleanup"
gameState.phase: "buy"
turnNumber: 3

Move 2 (Turn 4): phaseChanged: "action → buy"
gameState.phase: "buy"
turnNumber: 5
```
- After Turn 3 (phase=buy), phaseChanged says "buy → cleanup"
- But next response still shows phase=buy on Turn 5
- Turn incremented by 2 (3→5) without corresponding action phase or cleanup

### Issue 3: Turn Number Inconsistencies

**Severity**: HIGH

Turn numbering increments unpredictably:

| Move | Previous Turn | New Turn | Increment | Note |
|------|---------------|----------|-----------|------|
| Turn 1 end | 1 | 2 | +1 | Normal |
| Turn 2 end | 2 | 3 | +1 | Normal |
| Turn 3 end | 3 | 5 | +2 | **Unexpected jump** |
| Turn 5 end | 5 | 6 | +1 | Back to normal |
| Turn 11 end | 11 | 13 | +2 | **Another jump** |

The turns jump by 2 sometimes without clear reason. This breaks turn tracking.

### Issue 4: Invalid Move Rejection Reveals Internal State Mismatch

**Severity**: HIGH

When a move fails, the error message reveals the actual internal phase state, which differs from `gameState.phase`:

**Turn 13 (Apparent Buy Phase)**:
```json
REPORTED: gameState.phase = "buy"
validMoves includes: ["play_treasure Copper", "play_treasure Silver", ...]

ATTEMPT: play_treasure Copper
RESPONSE:
{
  "error": {
    "message": "Invalid move: \"play_treasure Copper\" is not legal in current game state.",
    "suggestion": "Cannot play treasures in action phase. You're in action phase - play action cards..."
  },
  "gameState": {
    "phase": "action"  // <-- CONTRADICTS previous response!
    "turnNumber": 14
  }
}
```

**Analysis**:
- Response before the move showed `phase: "buy"`
- After attempted move, same field shows `phase: "action"`
- This indicates the response object's phase field is stale or incorrectly populated

### Issue 5: Cleanup Phase Handling is Opaque

**Severity**: MEDIUM

Cleanup is described as "auto-skipped" but it's unclear:
- When does cleanup actually run?
- What happens to the hand between phases?
- Why is cleanup mentioned in `phaseChanged` if it's auto-skipped?

Example: After Turn 11 end, message says:
```
"end → Cleanup auto-skipped → action phase"
"phaseChanged": "buy → cleanup"
```

If cleanup was skipped, why is it in the transition message and in `phaseChanged`?

---

## Raw JSON Response Log

### Turn 1-2 Transition
```json
MOVE: end (Turn 1, action phase)
RESPONSE:
{
  "success": true,
  "message": "end → Cleanup auto-skipped → action phase",
  "gameState": {
    "phase": "action",
    "turnNumber": 2,
    "hand": {"Copper": 3, "Estate": 2},
    "currentCoins": 0,
    "currentActions": 1,
    "currentBuys": 1
  },
  "phaseChanged": "buy → cleanup"
}
```

### Turn 6 (Successful Treasure Play)
```json
MOVE: play_treasure Copper
RESPONSE:
{
  "success": true,
  "message": "Executed: play_treasure Copper",
  "gameState": {
    "phase": "buy",
    "turnNumber": 6,
    "hand": {"Copper": 2, "Silver": 1, "Estate": 1},
    "currentCoins": 1,
    "currentActions": 1,
    "currentBuys": 1
  }
}
```

### Turn 7 (Failed Treasure Play - Phase Mismatch)
```json
MOVE: play_treasure Copper
RESPONSE:
{
  "success": false,
  "error": {
    "message": "Invalid move: \"play_treasure Copper\" is not legal in current game state.",
    "suggestion": "Cannot play treasures in action phase. You're in action phase - play action cards or \"end\" to move to buy phase.",
    "details": {
      "currentPhase": "action",
      "playerHand": 5
    }
  },
  "gameState": {
    "phase": "action",
    "turnNumber": 7,
    "hand": {"Estate": 3, "Copper": 2},
    "currentCoins": 0,
    "currentActions": 1,
    "currentBuys": 1
  }
}
```

### Turn 11 → 13 Jump
```json
MOVE: end (Turn 11)
RESPONSE:
{
  "success": true,
  "message": "end → Cleanup auto-skipped → action phase",
  "gameState": {
    "phase": "action",
    "turnNumber": 13,  // jumped from 11!
    "hand": {"Estate": 3, "Copper": 1, "Silver": 1},
    "currentCoins": 0
  },
  "phaseChanged": "buy → cleanup"
}
```

### Turn 13 → 14 (Invalid Move Reveals State Mismatch)
```json
MOVE: play_treasure Copper (in apparent "buy" phase from Turn 13)
RESPONSE:
{
  "success": false,
  "error": {
    "message": "Invalid move: \"play_treasure Copper\" is not legal in current game state.",
    "suggestion": "Cannot play treasures in action phase. You're in action phase - play action cards..."
  },
  "gameState": {
    "phase": "action",  // was "buy" in previous response!
    "turnNumber": 14
  }
}
```

---

## Impact on Player Experience

### For Human Players
- **Confusion**: Impossible to predict valid moves from `gameState.phase` alone
- **Frustration**: Move rejections cite a different phase than what was displayed
- **Loss of Trust**: Inconsistent state makes game feel buggy
- **Phase Awareness**: Players cannot reliably understand what phase they're in

### For Testing & AI
- **Invalid Predictions**: AI systems relying on `gameState.phase` will make invalid move predictions
- **State Tracking**: Impossible to track game state reliably with response data
- **Error Analysis**: Hard to determine if move failures are legitimate or state bugs
- **Reproducibility**: Inconsistent state makes tests unreliable

---

## Root Cause Analysis (Hypothesis)

Based on the evidence, likely issues:

1. **Stale Phase in Response**: The `gameState.phase` field may be populated from a previous turn's state before the current move is processed
2. **Phase Updates Post-Response**: The actual game engine updates the phase after returning the response JSON
3. **Turn Increment Logic**: Turn number increments multiple times per phase transition, causing skips
4. **Cleanup State Machine**: The cleanup phase auto-skip mechanism doesn't properly update reported state

---

## Recommendations

### High Priority (Blocking Phase 4)

1. **Synchronize Phase Reporting**
   - Ensure `gameState.phase` in response reflects the ACTUAL current phase after move execution
   - Not the phase before the move was applied

2. **Fix phaseChanged Messages**
   - Make clear what the previous and current phases are
   - Remove "auto-skipped" language; explicitly state if cleanup ran or not
   - Format: `"previous → current"` with one clear transition

3. **Stabilize Turn Numbering**
   - Turn should increment exactly once per action→buy→cleanup cycle
   - Document when/why turn increments occur
   - Add regression tests for turn counting

4. **Add Phase Assertions**
   - Response schema should guarantee consistency between:
     - `gameState.phase`
     - `validMoves` array (e.g., if phase="buy", no action plays allowed)
     - `error.suggestion` messages
   - All three must agree on current phase

### Medium Priority

5. **Clarify Cleanup Mechanics**
   - Document when cleanup runs in single-player games
   - Explain why it's "auto-skipped" (is it actually skipped or implicit?)
   - Consider removing "auto-skipped" language; just report what phase you're in

6. **Add Response Validation**
   - Schema validation to catch phase mismatches before sending responses
   - Unit tests for response consistency

---

## Conclusion

**UX-002 FAILS** - Phase transition clarity is severely compromised. Players and systems cannot reliably determine what phase they're in based on server responses. This is a **critical blocker** for Phase 4 completion and must be resolved before advancing to Phase 5 (Web UI).

The fundamental issue is that `gameState.phase` does not reliably reflect the actual game state after move execution. This breaks the core contract between server and client.

**Recommendation**: Before merging to main or advancing phases, implement the High Priority fixes above and add comprehensive phase transition regression tests.

---

## Test Summary

- **Game ID**: game-1766321760587-2x5m0nl38
- **Moves Executed**: 15+
- **Turns Reached**: 15
- **Game Over**: No
- **Seed**: game-1766321760587-2x5m0nl38
- **Issues Found**: 5 critical/high severity
- **Test Status**: FAILED - Critical clarity issues detected
